/*
 * osgART / AR Toolkit for OpenSceneGraph
 * (C) 2004-2006 HIT Lab NZ, University of Canterbury
 *
 * Licensing is governed by the LICENSE.txt which is 
 * part of this library distribution.
 *
 */


#ifndef OSGART_GENERICTRACKER
#define OSGART_GENERICTRACKER 1


// std include
#include <map>
#include <iostream>

// local include
#include "osgART/Export"
#include "osgART/GenericVideo"
#include "osgART/Marker"
#include "osgART/Field"


namespace osgART {

	typedef struct {
	    int      width, height;
    	double   mat[3][4];
	    double   dist_factor[4];
	} CameraParameter;

	/**
	 * \class GenericTracker.
	 * 
	 * Base class for a tracker which in the context of AR is an entity 
	 * that connects video streams, markers and their representation in
	 * the virtual environment.
	 */
	class OSGART_EXPORT GenericTracker : public osg::Referenced
	{
	public:        
		/**
		 * \brief Constructor.
		 *
		 */
		GenericTracker();


		/** 
		 * \brief update the tracking.
		 * 
		 * This core function apply the Generic algorithm on the last 
		 * image defined by setImage.
		 */
		virtual void update() = 0;

		/*						
		osg::ref_ptr<Field> get(const std::string& name);		
		*/
		
		/**
		 * Access a field by its name. You need to cast
		 * the field into its respective type in order
		 * to access it.
		 * \param name Name of the field
		 * \return pointer to the field (0L if not found)
		 */
		Field* get(const std::string& name);
		
	
		/**
		 *
		 */
		virtual bool init(int xsize, int ysize, 
			const std::string& pattlist_name="Data/markers_list.dat",
			const std::string& camera_name="Data/camera_para.dat") = 0;
	  

		/**
		* \brief get GenericVideo id.
		* \return a GenericVideo identifier.
		*/
		int getId();


		/**
 		 * Return the camera model parameters.
		 * \return cameraparameter model identical to that of AR Toolkit
		 */
		const CameraParameter& getIntrinsicParameters() const;
		
		/** 
		* \brief Aet the image to analyzed.
		* 
		* \param image the new image for the tracking 
		*/
		void setImageRaw(unsigned char* image, 
			PixelFormatType format = VIDEOFORMAT_BGRA32);
	    
		/** 
		* \brief set the image to analyzed.
		* 
		* @param video the video object to use
		*/
		void setImage(GenericVideo* video);
	    
		/** 
		* \brief XXX.
		* 
		* XXX.
		*/
		Marker* getMarker(int markerId);
		
		unsigned int getMarkerCount() const;
		
		/** 
		* \brief get the openGL projection matrix.
		* 
		* delivers a usable matrix with openGL code (glLoadMatrixf(proj) with GL_MODELVIEW).
		* @param proj the openGL projection matrix computed
		*/
		virtual const double* getProjectionMatrix() const;
		 
	    
	protected:		
	
		FieldMap m_fields;
	
		    
		/** 
		 * \brief destructor.
		 *
		 */
		virtual ~GenericTracker();
	
		/**
		 * type for a vector of reference counted markers.
		 */
		typedef std::vector< osg::ref_ptr<Marker> > MarkerList;
		
		
		/**
		 * Camera parameters
		 */
		CameraParameter  	cparam; 		
		
		/**
		 * A list of markers associated with this tracker.
		 */ 
		MarkerList m_markerlist;

		
		unsigned char		*m_imageptr;
		PixelFormatType		 m_imageptr_format;
		
		
		double m_projectionMatrix[16];
	  
	private:

		int trackerId;
		static int trackerNum;
	};

};

#endif


